# TikTokè¯„è®ºæ•°æ®é›†æ„å»ºå™¨

## æ¦‚è¿°

`tiktok_comment_data_builder.py` æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç†TikTokè¯„è®ºæ•°æ®çš„æ„å»ºå™¨ï¼Œç»§æ‰¿è‡ªåŸºç¡€çš„ `DataBuilder` ç±»ã€‚å®ƒèƒ½å¤Ÿå¤„ç† `/mnt/hdfs/selection/tiktok_cmt` ç›®å½•ä¸‹çš„10ä¸ªåŒºé—´æ•°æ®é›†ï¼Œå°†åŸå§‹çš„ `doc` å­—æ®µè½¬æ¢ä¸ºSFTï¼ˆSupervised Fine-Tuningï¼‰è®­ç»ƒæ ¼å¼ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. æ•°æ®æºå¤„ç†
- å¤„ç†10ä¸ªåŒºé—´æ•°æ®é›†ï¼š`[0.0, 0.1)` åˆ° `[0.9, 1.0)`
- æ¯ä¸ªåŒºé—´åŒ…å«é¢„å¤„ç†è¿‡çš„ `train` å’Œ `val` ç›®å½•
- è‡ªåŠ¨åŠ è½½ç›®å½•ä¸­çš„æ‰€æœ‰parquetæ–‡ä»¶å¹¶åˆå¹¶

### 2. æ•°æ®æ ¼å¼è½¬æ¢
- å°†åŸå§‹çš„ `doc` å­—æ®µï¼ˆçº¯æ–‡æœ¬ï¼‰è½¬æ¢ä¸ºSFTè®­ç»ƒæ ¼å¼
- ç”Ÿæˆç”¨æˆ·-åŠ©æ‰‹å¯¹è¯æ ¼å¼çš„è®­ç»ƒæ•°æ®
- ä¿ç•™åŸå§‹æ•°æ®çš„å…ƒä¿¡æ¯ï¼ˆcomment_id, interval, languageç­‰ï¼‰

### 3. æ•°æ®é›†å˜ä½“ç”Ÿæˆ
- ç”Ÿæˆ1ä¸ªå…¨é‡æ•°æ®é›†ï¼ˆæ‰€æœ‰10ä¸ªåŒºé—´çš„ç»„åˆï¼‰
- ä¸ºæ¯ä¸ªåŒºé—´ç”Ÿæˆ4ç§å˜ä½“æ‰°åŠ¨ï¼š
  - `1/3` å˜ä½“ï¼šç›®æ ‡åŒºé—´çš„1/3 + å…¶ä»–æ‰€æœ‰åŒºé—´
  - `1/2` å˜ä½“ï¼šç›®æ ‡åŒºé—´çš„1/2 + å…¶ä»–æ‰€æœ‰åŒºé—´  
  - `2x` å˜ä½“ï¼šç›®æ ‡åŒºé—´çš„2å€ + å…¶ä»–æ‰€æœ‰åŒºé—´
  - `3x` å˜ä½“ï¼šç›®æ ‡åŒºé—´çš„3å€ + å…¶ä»–æ‰€æœ‰åŒºé—´
- æ€»è®¡ç”Ÿæˆ41ä¸ªè®­ç»ƒæ•°æ®é›†ï¼ˆ1 + 10*4ï¼‰

## æ•°æ®æ ¼å¼ç¤ºä¾‹

### åŸå§‹æ•°æ®æ ¼å¼
```json
{
  "comment_id": "7473130329534235400",
  "parent_id": "7473002417836150034",
  "doc": "è¿™ä¸ªè§†é¢‘å¤ªæœ‰è¶£äº†ï¼ğŸ˜‚",
  "interval": "[0.0, 0.1)",
  "language": "zh",
  "token_num": 19
}
```

### è½¬æ¢åçš„SFTæ ¼å¼
```json
{
  "text": "user: è¯·åˆ†æè¿™æ¡TikTokè¯„è®ºçš„å†…å®¹å’Œæƒ…æ„Ÿï¼š\nè¿™ä¸ªè§†é¢‘å¤ªæœ‰è¶£äº†ï¼ğŸ˜‚\nassistant: è¿™æ˜¯ä¸€æ¡TikTokè¯„è®ºã€‚è¯„è®ºå†…å®¹ä¸ºï¼šè¿™ä¸ªè§†é¢‘å¤ªæœ‰è¶£äº†ï¼ğŸ˜‚\n\nè¿™æ¡è¯„è®ºè¡¨è¾¾äº†ç”¨æˆ·çš„è§‚ç‚¹å’Œæƒ…æ„Ÿã€‚",
  "messages": [
    {
      "role": "user",
      "content": "è¯·åˆ†æè¿™æ¡TikTokè¯„è®ºçš„å†…å®¹å’Œæƒ…æ„Ÿï¼š\nè¿™ä¸ªè§†é¢‘å¤ªæœ‰è¶£äº†ï¼ğŸ˜‚"
    },
    {
      "role": "assistant", 
      "content": "è¿™æ˜¯ä¸€æ¡TikTokè¯„è®ºã€‚è¯„è®ºå†…å®¹ä¸ºï¼šè¿™ä¸ªè§†é¢‘å¤ªæœ‰è¶£äº†ï¼ğŸ˜‚\n\nè¿™æ¡è¯„è®ºè¡¨è¾¾äº†ç”¨æˆ·çš„è§‚ç‚¹å’Œæƒ…æ„Ÿã€‚"
    }
  ],
  "original_comment_id": "7473130329534235400",
  "interval": "[0.0, 0.1)",
  "language": "zh",
  "token_num": 19
}
```

## ä½¿ç”¨æ–¹æ³•

### 1. ç›´æ¥è¿è¡Œ
```bash
cd /Users/bytedance/Desktop/Github/sft_trainer
python src/data_split/tiktok_comment_data_builder.py
```

### 2. ä½œä¸ºæ¨¡å—å¯¼å…¥
```python
from src.data_split.tiktok_comment_data_builder import TikTokCommentDataBuilder

# åˆ›å»ºæ„å»ºå™¨å®ä¾‹
builder = TikTokCommentDataBuilder()

# æ„å»ºæ‰€æœ‰æ•°æ®é›†
builder.build_all_datasets()
```

### 3. è‡ªå®šä¹‰é…ç½®
```python
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
builder = TikTokCommentDataBuilder(config_path="custom_config.yaml")
```

## è¾“å‡ºç»“æ„

æ„å»ºå®Œæˆåï¼Œæ•°æ®é›†å°†ä¿å­˜åœ¨ä»¥ä¸‹ç›®å½•ï¼š

```
data/
â”œâ”€â”€ tiktok_training/
â”‚   â”œâ”€â”€ tiktok_full_dataset/
â”‚   â”œâ”€â”€ tiktok_00_01_1_3/
â”‚   â”œâ”€â”€ tiktok_00_01_1_2/
â”‚   â”œâ”€â”€ tiktok_00_01_2x/
â”‚   â”œâ”€â”€ tiktok_00_01_3x/
â”‚   â”œâ”€â”€ tiktok_01_02_1_3/
â”‚   â””â”€â”€ ... (å…±41ä¸ªè®­ç»ƒæ•°æ®é›†)
â””â”€â”€ tiktok_validation/
    â”œâ”€â”€ [0.0, 0.1)_val/
    â”œâ”€â”€ [0.1, 0.2)_val/
    â””â”€â”€ ... (å…±10ä¸ªéªŒè¯æ•°æ®é›†)
```

## é…ç½®è¦æ±‚

### ä¾èµ–åŒ…
- `datasets`
- `transformers` 
- `pyarrow`
- `pandas`
- `rich`
- `jinja2`

### é…ç½®æ–‡ä»¶
éœ€è¦ `configs/training_config.yaml` æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹é…ç½®ï¼š
```yaml
model:
  model_name: "Qwen/Qwen3-8B"
  trust_remote_code: true

training:
  seed: 42

data:
  token_limits:
    train_base: 660000
    validation: 1000000
```

## æ ¸å¿ƒæ–¹æ³•è¯´æ˜

### `convert_doc_to_sft_format(doc, comment_id)`
å°†åŸå§‹çš„docå­—æ®µè½¬æ¢ä¸ºSFTæ ¼å¼çš„messagesåˆ—è¡¨ã€‚

### `load_parquet_files_from_directory(directory_path)`
ä»æŒ‡å®šç›®å½•åŠ è½½æ‰€æœ‰parquetæ–‡ä»¶å¹¶åˆå¹¶ä¸ºå•ä¸ªDatasetã€‚

### `process_tiktok_dataset(dataset, dataset_name)`
å¤„ç†TikTokæ•°æ®é›†ï¼Œæ‰§è¡Œæ ¼å¼è½¬æ¢å’Œæ•°æ®æ¸…ç†ã€‚

### `create_training_variants(base_datasets)`
åˆ›å»ºè®­ç»ƒå˜ä½“ï¼ŒåŒ…æ‹¬å…¨é‡æ•°æ®é›†å’Œå„ç§æ‰°åŠ¨å˜ä½“ã€‚

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®è·¯å¾„**ï¼šç¡®ä¿ `/mnt/hdfs/selection/tiktok_cmt` è·¯å¾„å­˜åœ¨ä¸”å¯è®¿é—®
2. **å†…å­˜ä½¿ç”¨**ï¼šå¤„ç†å¤§å‹æ•°æ®é›†æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨æƒ…å†µ
3. **å­˜å‚¨ç©ºé—´**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ä¿å­˜ç”Ÿæˆçš„æ•°æ®é›†
4. **æƒé™**ï¼šç¡®ä¿å¯¹æ•°æ®ç›®å½•æœ‰è¯»å–æƒé™ï¼Œå¯¹è¾“å‡ºç›®å½•æœ‰å†™å…¥æƒé™

## æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š
```bash
python test_tiktok_builder.py
```

## æ‰©å±•æ€§

è¯¥æ„å»ºå™¨è®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œå®šåˆ¶ï¼š

1. **ä¿®æ”¹SFTæ ¼å¼**ï¼šé‡å†™ `convert_doc_to_sft_format` æ–¹æ³•
2. **æ·»åŠ æ•°æ®è¿‡æ»¤**ï¼šåœ¨ `process_tiktok_dataset` ä¸­æ·»åŠ è¿‡æ»¤é€»è¾‘
3. **è‡ªå®šä¹‰å˜ä½“**ï¼šä¿®æ”¹ `_create_interval_variants` æ–¹æ³•
4. **æ”¯æŒå…¶ä»–æ•°æ®æº**ï¼šé‡å†™ `load_source_datasets` æ–¹æ³•